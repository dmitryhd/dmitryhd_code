<?xml version="1.0" encoding="koi8-r"?>
<!DOCTYPE html
	PUBLIC "-//W3C//DTD XHTML 1.1//EN"
	 "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=koi8-r" />
<title>Fast SMB Search Installation Guide</title>
<link rel="stylesheet" href="/style.css" />
</head>
<body>
<h1>Fast SMB Search Installation</h1>
<h2>Прежде чем начать</h2>
<p>В данном документе предполагается, что вы <i>внимательно</i> и <i>целиком</i>
прочитали описание <a href="internals.html">внутреннего устройства</a>. Если
нет, то прочитайте, пожалуйста, его перед тем, как приступить к установке.</p>

<h2>Системные требования</h2>
<p>Для установки необходимо наличие и работоспособность следующих программ:
</p>
<ul>
<li>компилятор C++, реализация STL. Нужен хороший компилятор, поддерживающий
стандарт C++ на приемлемом уровне. Старые g++ (2.95, 2.96) для этой цели не
подходят (поддержка C++ чрезвычайно отвратительного качества). Если вы
пользуетесь g++, то рекомендуется использовать версию 3.3 или 3.4. Если у вас
есть доступ к каким-то другим компиляторам (Intel, MSVC, Borland) - попробуйте
скомпилировать ими и, пожалуйста, сообщите мне результат. Я почти уверен, что использование
оптимизирующего компилятора (Intel, MSVC) даст прирост скорости. К сожалению,
я не имею доступа к ним (лицензии на них стоят большое количество денег).</li>
<li>Apache 2. Возможна работа на Apache 1.3, но портированием я заниматься не
хочу, так как Apache 2.0 дает выигрыш по скорости.</li>
<li>SQL-сервер. Идеально подойдут обычные SQL-сервера вроде MySQL, PostgreSQL.
Применение чего-либо более тяжелого (например Oracle) здесь неоправданно,
никакого ускорения не будет.</li>
<li>Perl + необходимые модули (CGI, DBI, Socket, Apache, HTML::Template)</li>
<li>Samba 3.x. Существенным образом используются особенности Samba 3.x. Работа с версией
2.x невозможна.</li>
<li>Необходимо иметь под рукой исходный текст Samba. Желательно иметь ту же
версию, что и установлена в системе, но в принципе можно использовать и слегка
отличающуюся, например 3.0.8 вместо 3.0.9.</li>
<li>nmap</li>
</ul>

<h2>Подготовка</h2>
<p>Выделите какого-нибудь пользователя, с правами которого будет осуществляться
работа поискового сервера и сканирование. Это может быть как уже существующий,
так и новый, специально созданный пользователь. Остальные действия
проводятся от этого пользователя</p>
<p>Создайте какой-нибудь каталог, где будет храниться база. Она занимает
существенный объем (до 1 Гб). Поскольку она очень часто обновляется,
рекомендуется создавать ее где-нибудь в разделе /var, например
/var/tmp/smbsearch.</p>
<p>Распакуйте архив SMBSearch в некоторый каталог. Поисковая система будет работать
непосредственно оттуда. Специальной процедуры инсталляции, которая бы копировала их в
общесистемные каталоги вроде /usr/bin, нет. (Возможно, в будущем этот
недостаток будет устранен.)</p>

<h2>Подготовка SQL-сервера</h2>
<p>Создайте специальную базу данных и пользователя в SQL сервере. Для этого
войдите под пользователем с привилегиями администратора (БД, а не системы) и
выполните соотвествующую команду. Например для СУБД MySQL,</p>
<pre>
CREATE DATABASE smbsearch;
GRANT ALL PRIVILEGES ON smbsearch.* TO smb@localhost;
FLUSH PRIVILEGES;
</pre>
<p>Затем зайдите под только что созданным пользователем и создайте необходимые
таблицы данных, используя файл scripts/db.sql
<pre>mysql -usmb smbsearch &lt; scripts/db.sql</pre>
</p>

<h2>Сборка</h2>
<p>Необходимо собрать программы написанные на языке C/C++. Для сборки поискового
сервера достаточно выполнить команды ./configure и make в каталоге fsearch. При этом
появится исполняемый файл fsearch.</p>
<p>Сборка сканера значительно сложнее. Необходимо распаковать исходные
тексты Samba, сконфигурировать, а затем наложить патч samba.patch. Патч меняет
формат вывода с текстового на удобный для поискового сервера, а также
уменьшает таймаут на соединениях с 20 с до 2 с. Пример сборки в
системе Debian GNU/Linux:</p>
<pre>
[alex@laputa smbclient]$ apt-get source samba
Reading Package Lists... Done
Building Dependency Tree... Done
Need to get 15.3MB of source archives.
Get:1 ftp://debian.local unstable/main samba 3.0.9-1 (dsc) [957B]
Get:2 ftp://debian.local unstable/main samba 3.0.9-1 (tar) [15.2MB]
Get:3 ftp://debian.local unstable/main samba 3.0.9-1 (diff) [102kB]
Fetched 15.3MB in 6s (2311kB/s)
dpkg-source: extracting samba in samba-3.0.9
[alex@laputa smbclient]$ cd samba-3.0.9/
[alex@laputa samba-3.0.9]$ patch -p1 &lt;../samba.patch
patching file source/client/client.c
Hunk #13 succeeded at 661 with fuzz 1.
Hunk #14 succeeded at 2270 (offset 166 lines).
Hunk #15 succeeded at 2864 (offset 170 lines).
Hunk #16 succeeded at 3120 (offset 170 lines).
Hunk #17 succeeded at 3220 (offset 170 lines).
patching file source/libsmb/clientgen.c
Hunk #1 succeeded at 272 (offset 5 lines).
[alex@laputa samba-3.0.9]$ debian/rules build
....
[alex@laputa samba-3.0.9]$ cp source/bin/smbclient ../../scripts/psmbclient
[alex@laputa samba-3.0.9]$ cp source/bin/rpcclient ../../scripts/prpcclient
</pre>
<p>Из всей сборки нужны только 2 файла: smbclient и rpcclient. Их нужно собрать
и переименовать во избежание путаницы с общесистемными файлами.</p>

<h2>Список сетей и хостов</h2>
<p>После сборки нужно внести в SQL-сервер информацию о компьютерах в сети и
списке рабочих групп. Обычно у администраторов сетей имеется полная база данных
по всем клиентам. Оптимальный вариант - взять данные из этой базы. Если такой
вариант недоступен, можно попытаться настроить синхронизацию с DNS и взять
данные оттуда. Список сетей обычно небольшой и его можно ввести
непосредственно.</p>

<p>Поля в таблице hosts имеют следующий смысл:
<ul>
  <li />comp_id - идентификатор компьютера, главный ключ таблицы
  <li />wkg_id - идентификатор рабочей группы
  <li />ip - IP-адрес компьютера
  <li />name - имя компьютера, взятое, например, из dns или nmb
  <li />proto - протокол, в настоящее время поддерживаются: 0 - smb и 1 - ftp
  <li />charset - кодировка имен файлов, если не указана - брать кодировку из
  конфигурационного файла (см. ниже). Для smb пока не реализовано.
  <li />user, password - имя пользователя и пароль для неанонимного входа
  (если требуется). Для smb пока не реализовано.
</ul>
Остальные поля являются служебными, заполнять их на этапе установки
не следует.</p>

<p>Поля в таблице workgroups имеют следующий смысл:
<ul>
  <li />id - идентификатор рабочей группы и главный ключ таблицы; будьте
  внимательны, значение 0 зарезервировано и использоваться не должно
  <li />name - имя рабочей группы
  <li />prefix - символ, используемый в web-интерфейсе вместо полного имени
  рабочей группы для более компактного вывода результатов поиска, например,
  для рабочих групп NORTH и SOUTH это могуть быть N и S соответственно
</ul>

<h2>Конфигурационные файлы</h2>

<p>Основной конфигурационный файл служит для настройки работы скриптов и
называется searchconf.conf (он расположен в каталоге scripts).
Назначение большинства параметров описано в комментариях к ним.</p>
<p>Необходимо указать параметры для доступа к базе данных
(драйвер, имя базы, имя пользователя) в параметрах db_name, db_user
и каталог для хранения временных файлов (tmp_path).</p>
<p>Нужно указать путь к различным программам, в том числе к собранным
psmbclient, prpcclient, а также nmblookup, nmap.</p>
<p>Необходимо указать список локальных сетей. Первый параметр (local_subnets)
задает массив из строк, наличие одной из которых обязательно для адреса. С
помощью этого параметра отфильтровываются внешние (например Internet) адреса.
Второй параметр (scan_subnets) задает сети для сканирования в формате
nmap.</p>
<p>Если предполагается использовать синхронизацию с DNS, то 
следующим шагом служит настройка скрипта dns2hosts.pl, который заполняет
базу хостов по информации из DNS-сервера. Вначале указывается список имен,
которые не нужно добавлять. Обычно это различные алиасы или служебные роутеры,
на которых нет расшаренных файлов и их сканировать бессмыслленно. Список сетей
и адреса DNS-серверов, а также идентификаторы рабочих групп. В некоторых сетях
для удобства регистрируют специальные имена вида pc-xx-yy, где xx-yy означает
IP-адреса или номер комнаты в доме. Подобные имена только засоряют базу. Для
борьбы с ними существует последний параметр - это регулярное выражение, которое
их описывает.  Если имя попадает под такое выражение, то оно не добавляется в
базу. После настройки параметров обязательно убедитесь, что информация из DNS
берется корректно.</p>
<p>Эти же параметры необходимо определить и в файле html/SMBConf.pm
для корректного доступа из CGI-скриптов.</p>

<h2>Запуск сервера</h2>
<p>После заполнения таблиц hosts и workgroups правильным содержимым, можно запустить
поисковый сервер. Обязательно убедитесь, что сервер работает корректно!</p>
<pre>
[alex@laputa smbsearch]$ cd fsearch/
[alex@laputa fsearch]$ ./fsearch &amp;
[1] 16531
[alex@laputa fsearch]$ renice +1 16531
16531: old priority 0, new priority 1
[alex@laputa fsearch]$ chmod o+rw /tmp/fastsmb.sock
[alex@laputa fsearch]$ ./fcon.pl
Welcome to fsearch console! Enter request, empty line to exit
STATUS
Server replied: 1 clients active, 0 hosts, 0 files, 0 items in cache, 0 Mb memory used

[alex@laputa fsearch]$
</pre>
<p>Рекомендуется запускать сервер со слегка пониженным приоритетом, чтобы он не
мешал основной работе на компьютере. Также необходимо поставить права доступа
на сокет командой chmod, чтобы CGI-скрипты, работающие с правами web-сервера,
смогли получить к нему доступ.</p>
<p>Если база данных с файлами уже есть, ее можно загрузить командой
scripts/startfsmb.pl. Она просматривает каталог, описанный в конфигурационном
файле параметром tmp_path, и загружает имеющиеся списки файлов.
При первом запуске никакой пользы от этой команды не будет.</p>

<h2>Установка запуска по расписанию</h2>
<p> После настройки параметров нужно сделать так, чтобы сканер и чекер
заполнялись автоматически по расписанию. Для этого нужно составить файл
crontab, где указать когда и какие файлы нужно запускать. Например, можно
поставить запускаться чекер раз в 8 минут, а сканер - раз в 15 минут:</p>
<pre>
*/8 * * * * /local/home/alex/src/smbsearch/scripts/check.sh
*/15 * * * * /local/home/alex/src/smbsearch/scripts/rescan.sh
</pre>
<p>После редактирования файла нужно отдать его системе автоматического запуска
задач при помощи команды</p>
<pre>
[alex@laputa scripts]$ crontab mycrontab
[alex@laputa scripts]$ crontab -l
*/8 * * * * /local/home/alex/src/smbsearch/scripts/check.sh
*/15 * * * * /local/home/alex/src/smbsearch/scripts/rescan.sh
</pre>
<p>После установки имеет смысл подождать некоторое время пока скрипты
запустятся пару раз и просканируют найденные хосты.</p>

<h2>Настройка Web-интерфейса</h2>
<p>Нужно создать каталог в том месте где располагаются файлы web-сервера и
скопировать в этот каталог файлы из подкаталога html. Затем нужно
отредактировать конфигурационный файл web-сервера. Например, возможна такая
конфигурация:</p>
<pre>
	DocumentRoot /local/www/html
	&lt;Directory /&gt;
		Options FollowSymLinks
		AllowOverride None
	&lt;/Directory&gt;

	PerlRequire /local/www/html/startup.pl
	&lt;Directory /local/www/html&gt;
		Options Indexes FollowSymLinks MultiViews ExecCGI
		AllowOverride All
		Order allow,deny
		allow from all

		&lt;Files *.pl&gt;
			SetHandler perl-script
			PerlResponseHandler ModPerl::Registry
			Options +ExecCGI
		&lt;Files&gt;
	&lt;/Directory&gt;
</pre>
<p>Перезапустите web-сервер. При успешной настройке страницы станут доступными.
Зайдите в браузере на /serverstat.pl. Здесь отображается внутренне состояние
сервера. </p>
<p> При правильной настройке системы поиск должен быть уже
работоспособен. Возможно придется подождать некоторое время, пока
пересканируется вся сеть. </p>
<p>ЗАМЕЧАНИЕ: Вам придется закрыть html/Common.pm от общего доступа. Для этого достаточно сделать chmod 600 html/Common.pm.</p>
<hr />
<p><b>Fast SMB Search</b> is written by Sasha, write to
<a href="mailto:alex@sectorb.msk.ru">alex@sectorb.msk.ru</a></p>
</body></html>
